<section class="search-bar bg-dark border-bottom border-danger py-4">
  <div class="container text-center">
    <input type="text" id="search" class="form-control w-100 w-sm-75 w-md-50 mx-auto" placeholder="Buscar ...">
  </div>
</section>

<!-- Lista horizontal de géneros -->
<div class="filtro-generos-horizontal bg-dark py-3">
  <div class="container d-flex flex-wrap justify-content-center gap-2">
    <a href="#" data-genero="" class="genero-link active btn btn-outline-danger">Todos</a>
    <a href="#" th:each="genero : ${generos}" 
       th:attr="data-genero=${genero.nombre}" 
       th:text="${genero.nombre}" 
       class="genero-link btn btn-outline-danger">
    </a>
  </div>
</div>

<!-- Sección de juegos -->
<section class="games container">
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 justify-content-center">
    <th:block th:each="juego : ${juegos}">
      <div class="col">
        <div class="game-card bg-dark text-white justify-content-between" 
             th:attr="data-name=${juego.nombre.toLowerCase()}"
             th:attrappend=" data-generos=${juego.nombresGeneros}">
          <a th:href="@{/juego/r/{id}(id=${juego.id})}" target="_self" class="text-decoration-none text-white">
            <div th:if="${juego.portada != null}">
              <img th:src="@{'/uploads/' + ${juego.portada.ruta}}" th:alt="${juego.nombre}" class="img-fluid rounded" />
            </div>
            <h3 th:text="${juego.nombre}"></h3>
            <p class="precio" 
               th:text="${juego.precioActual != null 
                         ? (juego.precioActual.cantidad.compareTo(T(java.math.BigDecimal).ZERO) == 0 
                            ? 'Gratis' 
                            : juego.precioActual.cantidad + ' €') 
                         : 'Sin precio'}">
            </p>
            <div class="categories">
              <span th:each="genero : ${juego.generos}" class="category badge bg-danger me-1" th:text="${genero.nombre}"></span>
            </div>
          </a>
        </div>
      </div>
    </th:block>
  </div>
</section>

<!-- Filtro por texto y género -->
<script>
  const searchInput = document.getElementById('search');
  const gameCards = document.querySelectorAll('.game-card');
  const generoLinks = document.querySelectorAll('.genero-link');

  let generoSeleccionado = null;

  searchInput.addEventListener('input', filtrarJuegos);

  generoLinks.forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();

      generoSeleccionado = this.dataset.genero || null;

      generoLinks.forEach(l => l.classList.remove('active'));
      this.classList.add('active');

      filtrarJuegos();
    });
  });

  function filtrarJuegos() {
    const filtroTexto = searchInput.value.toLowerCase();

    gameCards.forEach(card => {
      const nombre = card.getAttribute('data-name').toLowerCase();
      const generosAttr = card.getAttribute('data-generos');
      const generos = generosAttr ? generosAttr.split(',').map(g => g.trim()) : [];

      const coincideTexto = nombre.includes(filtroTexto);
      const coincideGenero = !generoSeleccionado || generoSeleccionado === "" || generos.includes(generoSeleccionado);

      card.style.display = (coincideTexto && coincideGenero) ? '' : 'none';
    });
  }
</script>

<!-- Mensajes de alerta -->
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function () {
    let successMsg = /*[[${success}]]*/ null;
    let cancelMsg = /*[[${cancel}]]*/ null;

    setTimeout(() => {
      if (successMsg) {
        alert(successMsg);
        removeQueryParam('success');
      } else if (cancelMsg) {
        alert(cancelMsg);
        removeQueryParam('cancel');
      }
    }, 500);

    function removeQueryParam(param) {
      const url = new URL(window.location);
      url.searchParams.delete(param);
      window.history.replaceState({}, document.title, url.toString());
    }
  });
</script>

<script th:if="${alertaRechazo}" type="text/javascript">
  window.addEventListener('DOMContentLoaded', () => {
    alert("Tu solicitud como desarrollador ha sido rechazada.");
  });
</script>