<div class="juego-container">
    <div class="imagenes-columna">
        <img id="portada" th:src="${juego.portada.ruta}" alt="Portada principal del juego" />

        <div id="miniaturas-carrusel" class="miniaturas-carrusel">
            <button id="prevBtn" class="carrusel-btn">&lt;</button>
            <div class="miniaturas-wrapper">
                <img
                    th:src="${juego.portada.ruta}"
                    th:attr="data-ruta-imagen=${juego.portada.ruta}"
                    class="miniatura-img portada-fija"
                    alt="Miniatura portada de [[${juego.nombre}]]" />
                <img
                    th:each="imagen : ${juego.imagenes}"
                    th:if="${imagen.ruta != juego.portada.ruta}"
                    th:src="${imagen.ruta}"
                    th:attr="data-ruta-imagen=${imagen.ruta}"
                    class="miniatura-img"
                    alt="Imagen miniatura de [[${juego.nombre}]]" />
            </div>
            <button id="nextBtn" class="carrusel-btn">&gt;</button>
        </div>

        <div class="descripcion-desarrollador-container">
            <p class="juego-desarrollador">
                Desarrollado por
                <span th:text="${juego.desarrollador.nombre + ' ' + juego.desarrollador.apellido}">Nombre Apellido</span>
            </p>
            <p th:text="${juego.descripcion}" class="juego-descripcion">Descripción del juego</p>
        </div>
    </div>

    <div class="precio-columna">
        <h1 th:text="${juego.nombre}" class="juego-titulo"></h1>

        <div class="valoracion-media">
            <h4>Valoración media</h4>
            <div class="valoracion solo-lectura media">
                <span class="estrella" data-valor="1">&#9733;</span>
                <span class="estrella" data-valor="2">&#9733;</span>
                <span class="estrella" data-valor="3">&#9733;</span>
                <span class="estrella" data-valor="4">&#9733;</span>
                <span class="estrella" data-valor="5">&#9733;</span>
            </div>
        </div>

        <div th:if="${valoracionUsuario != null}" class="valoracion-usuario">
            <h4>Tu valoración</h4>
            <div class="valoracion editable-usuario">
                <span class="estrella" data-valor="1">&#9733;</span>
                <span class="estrella" data-valor="2">&#9733;</span>
                <span class="estrella" data-valor="3">&#9733;</span>
                <span class="estrella" data-valor="4">&#9733;</span>
                <span class="estrella" data-valor="5">&#9733;</span>
            </div>
        </div>

        <div th:if="${user == null}" class="sin-sesion">
            <small>Inicia sesión para valorar este juego.</small>
        </div>
        <div th:if="${user != null and !tieneJuego}" class="sin-juego">
            <small>No puedes valorar este juego porque no lo has comprado.</small>
        </div>

        <h3 th:if="${juego.precioActual != null}"
            th:text="${juego.precioActual.cantidad.compareTo(T(java.math.BigDecimal).ZERO) == 0 ? 
                     'Gratis' : juego.precioActual.cantidad + ' €'}"
            class="juego-precio">
        </h3>
        <h3 th:if="${juego.precioActual == null}" class="juego-precio">Sin precio</h3>

        <a th:href="@{'/compra/c/' + ${juego.id}}" class="boton-comprar">Comprar</a>
    </div>
</div>

<div class="seccion-comentarios">
    <h2>Comentarios</h2>

    <div th:if="${user != null and tieneJuego}">
        <form th:action="@{/comentario/cpost}" method="post">
            <input type="hidden" name="juegoId" th:value="${juego.id}" />
            <textarea name="contenido" placeholder="Escribe un comentario" required></textarea>
            <button type="submit">Enviar comentario</button>
        </form>
    </div>

    <div th:if="${#lists.isEmpty(comentarios)}">
        <p>Este juego aún no tiene comentarios.</p>
    </div>

    <div th:each="comentario : ${comentarios}" class="comentario d-flex justify-content-between align-items-start" style="position: relative;">
        <div>
            <p>
                <span th:text="${comentario.usuario.nombre + ' ' + comentario.usuario.apellido}" class="comentario-autor">Usuario</span>
            </p>
            <p th:text="${comentario.contenido}" class="comentario-contenido">Contenido del comentario</p>
        </div>

        <div th:if="${user != null and comentario.usuario.id != user.id}" class="dropdown" style="margin-left: 1rem;">
            <button class="btn btn-link text-dark p-0"
                    type="button"
                    th:id="'dropdownMenuButton-' + ${comentario.id}"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    aria-label="Opciones comentario">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                     fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                    <path d="M9.5 12.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 
                             1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                </svg>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" th:attr="aria-labelledby='dropdownMenuButton-' + ${comentario.id}">
                <li>
                    <form method="get" th:action="@{/comentario/reportar/form}">
                        <input type="hidden" name="comentarioId" th:value="${comentario.id}" />
                        <input type="hidden" name="juegoId" th:value="${juego.id}" />
                        <button type="submit" class="dropdown-item">Reportar</button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</div>

<div id="juego-data"
     th:attr="data-juego-id=${juego.id},
              data-user-logged=${user != null},
              data-tiene-juego=${tieneJuego},
              data-valoracion-media=${valoracionMedia != null ? valoracionMedia : 0},
              data-valoracion-usuario=${valoracionUsuario != null ? valoracionUsuario : 'null'}"
     style="display: none;"></div>

<script src="/js/juego.js"></script>