<div class="container">
  <h1>Editar juego</h1>

  <form th:action="@{/juego/u}" method="post" enctype="multipart/form-data" onsubmit="return validarFormulario()"
    class="form-grid">
    <input type="hidden" name="id" th:value="${juego.id}" />

    <!-- Nombre -->
    <div class="form-group">
      <label for="idNombre">Nombre</label>
      <input id="idNombre" type="text" name="nombre" th:value="${juego.nombre}" required autofocus />
    </div>

    <!-- Precio -->
    <div class="form-group">
      <label for="precio">Precio (€)</label>
      <input type="number" step="0.01" min="0" id="precio" name="precio"
        th:value="${juego.precioActual != null ? juego.precioActual.cantidad : 0}" placeholder="Introduce el precio"
        required />
    </div>

    <!-- Descripción -->
    <div class="form-group full-width">
      <label for="idDesc">Descripción</label>
      <textarea id="idDesc" name="descripcion" rows="4" required th:text="${juego.descripcion}"></textarea>
    </div>

    <!-- Géneros -->
    <div class="form-group full-width">
      <label>Géneros:</label>
      <div class="checkbox-inline-group" id="generos-container">
        <span th:each="genero : ${generos}">
          <label>
            <input type="checkbox" name="generosIds" th:value="${genero.id}"
              th:checked="${juego.generos.contains(genero)}" />
            <span th:text="${genero.nombre}"></span>
          </label>
        </span>
      </div>
      <div id="error-generos" style="color:red; display:none;">Selecciona al menos un género.</div>
    </div>

    <!-- Portada -->
    <div class="form-group full-width">
      <label for="portada">Nueva portada (opcional):</label>
      <input id="portada" type="file" name="portadaFile" accept="image/*" />
      <div id="portadaPreview">
        <img th:if="${juego.portada.ruta != null}" th:src="${juego.portada.ruta}" class="preview-img" />
        <!--<button type="button" id="eliminarPortadaBtn" style="display:none; margin-top: 5px;">Eliminar portada actual</button>-->
        <button type="button" class="delete-btn" onclick="eliminarImagenActual(this)">&times;</button>
      </div>
    </div>

    <!-- Imágenes actuales -->
    <div class="form-group full-width">
      <label>Imágenes actuales:</label>
      <div id="imagenesActualesPreview">
        <div th:each="imagen : ${juego.imagenes}" th:if="${!imagen.portada}" class="preview-img-wrapper">
          <img th:src="${imagen.ruta}" class="preview-img" />
          <input type="hidden" name="imagenesExistentes" th:value="${imagen.id}" />
          <button type="button" class="delete-btn" onclick="eliminarImagenActual(this)">&times;</button>
        </div>
      </div>
    </div>

    <!-- Imágenes nuevas -->
    <div class="form-group full-width">
      <label for="imagenes">Añadir nuevas imágenes:</label>
      <input id="imagenes" type="file" name="imagenes" multiple accept="image/*" />
      <div id="imagenesPreview"></div>
    </div>

    <!-- Archivo descargable -->
    <div>
      <label>Archivo descargable actual:</label>
      <a th:href="@{'/download/' + ${juego.id}}" target="_blank" th:text="${juego.nombreDescargableOriginal}">Descargar
        archivo actual</a>
    </div>

    <div class="form-group full-width">
      <label for="descargable">Nuevo archivo descargable (opcional):</label>
      <input type="file" id="descargable" name="descargable" accept=".zip,.rar,.exe,.iso,.setup" />
    </div>

    <!-- Botón -->
    <div class="form-group full-width">
      <input type="submit" value="Guardar cambios" />
    </div>
  </form>
</div>

<script>
  let archivoPortada = null;
  let archivosImagenes = [];
  let portadaEliminada = false;

  const portadaInput = document.getElementById('portada');
  const portadaPreview = document.getElementById('portadaPreview');
  const imagenesInput = document.getElementById('imagenes');
  const imagenesPreview = document.getElementById('imagenesPreview');

  // === NUEVO: Añadir botón eliminar si hay portada precargada ===
  window.addEventListener('DOMContentLoaded', () => {
    const img = portadaPreview.querySelector('img');
    if (img) {
      const src = img.src;
      mostrarPortadaDesdeSrc(src);
    }
  });

  portadaInput.addEventListener('change', (e) => {
    if (e.target.files.length === 0) {
      archivoPortada = null;
      portadaPreview.innerHTML = '';
      return;
    }

    archivoPortada = e.target.files[0];
    portadaEliminada = false;
    mostrarPortadaPreview(archivoPortada);
  });

  function mostrarPortadaPreview(archivo) {
    const reader = new FileReader();
    reader.onload = function (e) {
      mostrarPortadaDesdeSrc(e.target.result);
    };
    reader.readAsDataURL(archivo);
  }

  function mostrarPortadaDesdeSrc(src) {
    portadaPreview.innerHTML = '';

    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100px';
    container.style.height = '100px';
    container.style.border = '1px solid #ccc';
    container.style.borderRadius = '4px';
    container.style.overflow = 'hidden';

    const img = document.createElement('img');
    img.src = src;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    container.appendChild(img);

    const btnEliminar = document.createElement('button');
    btnEliminar.innerHTML = '&times;';
    btnEliminar.type = 'button';
    btnEliminar.title = 'Eliminar imagen de portada';
    Object.assign(btnEliminar.style, {
      position: 'absolute', top: '2px', right: '2px',
      background: 'rgba(255, 0, 0, 0.8)', color: 'white',
      border: 'none', borderRadius: '50%', width: '20px', height: '20px',
      cursor: 'pointer', fontSize: '16px', lineHeight: '18px', padding: '0'
    });

    btnEliminar.onclick = () => {
      archivoPortada = null;
      portadaEliminada = true;
      portadaPreview.innerHTML = '';
      portadaInput.value = '';
    };

    container.appendChild(btnEliminar);
    portadaPreview.appendChild(container);
  }

  imagenesInput.addEventListener('change', (e) => {
    const nuevosArchivos = Array.from(e.target.files);
    if (archivosImagenes.length + nuevosArchivos.length > 5) {
      alert('Solo puedes subir hasta 5 imágenes.');
      return;
    }

    archivosImagenes = archivosImagenes.concat(nuevosArchivos);
    actualizarPreview();
    imagenesInput.value = '';
  });

  function actualizarPreview() {
    imagenesPreview.innerHTML = '';

    archivosImagenes.forEach((archivo, index) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        const container = document.createElement('div');
        container.style.position = 'relative';
        container.style.width = '100px';
        container.style.height = '100px';
        container.style.border = '1px solid #ccc';
        container.style.borderRadius = '4px';
        container.style.overflow = 'hidden';

        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        container.appendChild(img);

        const btnEliminar = document.createElement('button');
        btnEliminar.innerHTML = '&times;';
        btnEliminar.type = 'button';
        btnEliminar.title = 'Eliminar imagen';
        Object.assign(btnEliminar.style, {
          position: 'absolute', top: '2px', right: '2px',
          background: 'rgba(255, 0, 0, 0.8)', color: 'white',
          border: 'none', borderRadius: '50%', width: '20px', height: '20px',
          cursor: 'pointer', fontSize: '16px', lineHeight: '18px', padding: '0'
        });

        btnEliminar.onclick = () => {
          archivosImagenes.splice(index, 1);
          actualizarPreview();
        };

        container.appendChild(btnEliminar);
        imagenesPreview.appendChild(container);
      };
      reader.readAsDataURL(archivo);
    });
  }

  function validarFormulario() {
    const nombre = document.getElementById('idNombre').value.trim();
    if (nombre === '') {
      alert('El nombre es obligatorio.');
      return false;
    }

    const precio = document.getElementById('precio').value;
    if (precio === '') {
      alert('El precio es obligatorio.');
      return false;
    }

    const descripcion = document.getElementById('idDesc').value.trim();
    if (descripcion === '') {
      alert('La descripción es obligatoria.');
      return false;
    }

    const checkboxes = document.querySelectorAll('input[name="generosIds"]:checked');
    const errorGeneros = document.getElementById('error-generos');
    if (checkboxes.length === 0) {
      errorGeneros.style.display = 'block';
      alert('Selecciona al menos un género.');
      return false;
    }
    errorGeneros.style.display = 'none';

    const portadaExistente = document.querySelector('#portadaPreview img') !== null;
    if (!archivoPortada && !portadaExistente && !portadaEliminada) {
      alert('Debes seleccionar una portada.');
      return false;
    }
    if (portadaEliminada && !archivoPortada) {
      alert('Has eliminado la portada actual, debes subir una nueva.');
      return false;
    }

    const imagenesExistentes = document.querySelectorAll('input[name="imagenesExistentes"]').length;
    const imagenesNuevas = archivosImagenes.length;
    if (imagenesExistentes + imagenesNuevas === 0) {
      alert('Debes tener al menos una imagen adicional.');
      return false;
    }

    const portadaDataTransfer = new DataTransfer();
    if (archivoPortada) {
      portadaDataTransfer.items.add(archivoPortada);
      portadaInput.files = portadaDataTransfer.files;
    }

    const imagenesDataTransfer = new DataTransfer();
    archivosImagenes.forEach(file => imagenesDataTransfer.items.add(file));
    imagenesInput.files = imagenesDataTransfer.files;

    return true;
  }
</script>