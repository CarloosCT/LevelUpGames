<div class="container">
  <h1>Nuevo juego</h1>

  <form action="/juego/c" method="post" enctype="multipart/form-data" onsubmit="return validarFormulario()">
    <label for="idNombre">Nombre</label>
    <input id="idNombre" type="text" name="nombre" required autofocus />
    <br><br>

    <label for="idDesc">Descripción</label>
    <br>
    <textarea id="idDesc" name="descripcion" rows="6" cols="50" required></textarea>
    <br/><br/>

    <label>Géneros:</label>
    <div class="checkbox-inline-group" id="generos-container">
      <!-- Simulación estática de géneros, reemplaza por tu código con Thymeleaf -->
      <span th:each="genero : ${generos}">
        <label><input type="checkbox" name="generosIds" th:value="${genero.id}" th:text="${genero.nombre}"> </label>
      </span>
    </div>
    <div id="error-generos" style="color:red; display:none;">Selecciona al menos un género.</div>
    <br/><br/>

    <label for="precio">Precio (€):</label>
    <input type="number" step="0.01" min="0" id="precio" name="precio" placeholder="Introduce el precio" required />
    <br/><br/>

    <label for="portada">Selecciona una imagen de portada:</label>
    <input id="portada" type="file" name="portadaFile" accept="image/*" required />
    <div id="portadaPreview" style="margin-top: 10px; width: 100px; height: 100px; position: relative;"></div>
    <br/><br/>

    <label for="imagenes">Selecciona hasta 5 imágenes:</label>
    <input id="imagenes" type="file" name="imagenes" multiple accept="image/*" />
    <div id="imagenesPreview" style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;"></div>
    <br/><br/>

    <input type="submit" value="Crear nuevo juego" />
  </form>
</div>

<script>
  let archivoPortada = null;
  let archivosImagenes = [];

  const portadaInput = document.getElementById('portada');
  const portadaPreview = document.getElementById('portadaPreview');
  const imagenesInput = document.getElementById('imagenes');
  const imagenesPreview = document.getElementById('imagenesPreview');

  portadaInput.addEventListener('change', (e) => {
    if (e.target.files.length === 0) {
      archivoPortada = null;
      portadaPreview.innerHTML = '';
      return;
    }

    archivoPortada = e.target.files[0];
    mostrarPortadaPreview(archivoPortada);
  });

  function mostrarPortadaPreview(archivo) {
    portadaPreview.innerHTML = '';

    const reader = new FileReader();
    reader.onload = function (e) {
      const container = document.createElement('div');
      container.style.position = 'relative';
      container.style.width = '100px';
      container.style.height = '100px';
      container.style.border = '1px solid #ccc';
      container.style.borderRadius = '4px';
      container.style.overflow = 'hidden';

      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      container.appendChild(img);

      const btnEliminar = document.createElement('button');
      btnEliminar.innerHTML = '&times;';
      btnEliminar.type = 'button';
      btnEliminar.title = 'Eliminar imagen de portada';
      Object.assign(btnEliminar.style, {
        position: 'absolute', top: '2px', right: '2px', background: 'rgba(255, 0, 0, 0.8)', color: 'white',
        border: 'none', borderRadius: '50%', width: '20px', height: '20px', cursor: 'pointer',
        fontSize: '16px', lineHeight: '18px', padding: '0'
      });

      btnEliminar.onclick = () => {
        archivoPortada = null;
        portadaPreview.innerHTML = '';
        portadaInput.value = '';
      };

      container.appendChild(btnEliminar);
      portadaPreview.appendChild(container);
    };
    reader.readAsDataURL(archivo);
  }

  imagenesInput.addEventListener('change', (e) => {
    const nuevosArchivos = Array.from(e.target.files);
    if (archivosImagenes.length + nuevosArchivos.length > 5) {
      alert('Solo puedes subir hasta 5 imágenes.');
      return;
    }

    archivosImagenes = archivosImagenes.concat(nuevosArchivos);
    actualizarPreview();
    imagenesInput.value = '';
  });

  function actualizarPreview() {
    imagenesPreview.innerHTML = '';

    archivosImagenes.forEach((archivo, index) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        const container = document.createElement('div');
        container.style.position = 'relative';
        container.style.width = '100px';
        container.style.height = '100px';
        container.style.border = '1px solid #ccc';
        container.style.borderRadius = '4px';
        container.style.overflow = 'hidden';

        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        container.appendChild(img);

        const btnEliminar = document.createElement('button');
        btnEliminar.innerHTML = '&times;';
        btnEliminar.type = 'button';
        btnEliminar.title = 'Eliminar imagen';
        Object.assign(btnEliminar.style, {
          position: 'absolute', top: '2px', right: '2px', background: 'rgba(255, 0, 0, 0.8)', color: 'white',
          border: 'none', borderRadius: '50%', width: '20px', height: '20px', cursor: 'pointer',
          fontSize: '16px', lineHeight: '18px', padding: '0'
        });

        btnEliminar.onclick = () => {
          archivosImagenes.splice(index, 1);
          actualizarPreview();
        };

        container.appendChild(btnEliminar);
        imagenesPreview.appendChild(container);
      };
      reader.readAsDataURL(archivo);
    });
  }

  function validarFormulario() {
    // Validar géneros
    const checkboxes = document.querySelectorAll('input[name="generosIds"]:checked');
    const error = document.getElementById('error-generos');
    if (checkboxes.length === 0) {
      error.style.display = 'block';
      return false;
    }
    error.style.display = 'none';

    // Asignar portada al input file
    const portadaDataTransfer = new DataTransfer();
    if (archivoPortada) {
      portadaDataTransfer.items.add(archivoPortada);
      portadaInput.files = portadaDataTransfer.files;
    }

    // Asignar imágenes
    const imagenesDataTransfer = new DataTransfer();
    archivosImagenes.forEach(file => imagenesDataTransfer.items.add(file));
    imagenesInput.files = imagenesDataTransfer.files;

    return true;
  }
</script>
