<div class="container">
  <h1>Nuevo juego</h1>

  <form action="/juego/c" method="post" enctype="multipart/form-data" onsubmit="return validarFormulario()" class="form-grid">

    <!-- Nombre -->
    <div class="form-group">
      <label for="idNombre">Nombre</label>
      <input id="idNombre" type="text" name="nombre" required autofocus />
    </div>

    <!-- Precio -->
    <div class="form-group">
      <label for="precio">Precio (€)</label>
      <input type="number" step="0.01" min="0" id="precio" name="precio" placeholder="Introduce el precio" required />
    </div>

    <!-- Descripción -->
    <div class="form-group full-width">
      <label for="idDesc">Descripción</label>
      <textarea id="idDesc" name="descripcion" rows="4" required></textarea>
    </div>

    <!-- Géneros -->
    <div class="form-group full-width">
      <label>Géneros:</label>
      <div class="checkbox-inline-group" id="generos-container">
        <!-- Thymeleaf ejemplo -->
        <span th:each="genero : ${generos}">
          <label><input type="checkbox" name="generosIds" th:value="${genero.id}" th:text="${genero.nombre}"> </label>
        </span>
      </div>
      <div id="error-generos" style="color:red; display:none;">Selecciona al menos un género.</div>
    </div>

    <!-- Portada -->
    <div class="form-group full-width">
      <label for="portada">Selecciona una imagen de portada:</label>
      <input id="portada" type="file" name="portadaFile" accept="image/*" required />
      <div id="portadaPreview"></div>
    </div>

    <!-- Imágenes -->
    <div class="form-group full-width">
      <label for="imagenes">Selecciona hasta 5 imágenes:</label>
      <input id="imagenes" type="file" name="imagenes" multiple accept="image/*" />
      <div id="imagenesPreview"></div>
    </div>

   <!-- Descargable -->
  <div class="form-group full-width">
    <label for="descargable">Archivo descargable (.exe, .setup, .iso, .zip):</label>
    <input type="file" id="descargable" name="descargable" accept=".zip,.rar,.exe,.iso,.setup" required>
  </div>

    <!-- Botón -->
    <div class="form-group full-width">
      <input type="submit" value="Crear nuevo juego" />
    </div>
  </form>
</div>

<script>
  let archivoPortada = null;
  let archivosImagenes = [];

  const portadaInput = document.getElementById('portada');
  const portadaPreview = document.getElementById('portadaPreview');
  const imagenesInput = document.getElementById('imagenes');
  const imagenesPreview = document.getElementById('imagenesPreview');

  portadaInput.addEventListener('change', (e) => {
    if (e.target.files.length === 0) {
      archivoPortada = null;
      portadaPreview.innerHTML = '';
      return;
    }

    archivoPortada = e.target.files[0];
    mostrarPortadaPreview(archivoPortada);
  });

  function mostrarPortadaPreview(archivo) {
    portadaPreview.innerHTML = '';

    const reader = new FileReader();
    reader.onload = function (e) {
      const container = document.createElement('div');
      container.style.position = 'relative';
      container.style.width = '100px';
      container.style.height = '100px';
      container.style.border = '1px solid #ccc';
      container.style.borderRadius = '4px';
      container.style.overflow = 'hidden';

      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      container.appendChild(img);

      const btnEliminar = document.createElement('button');
      btnEliminar.innerHTML = '&times;';
      btnEliminar.type = 'button';
      btnEliminar.title = 'Eliminar imagen de portada';
      Object.assign(btnEliminar.style, {
        position: 'absolute', top: '2px', right: '2px', background: 'rgba(255, 0, 0, 0.8)', color: 'white',
        border: 'none', borderRadius: '50%', width: '20px', height: '20px', cursor: 'pointer',
        fontSize: '16px', lineHeight: '18px', padding: '0'
      });

      btnEliminar.onclick = () => {
        archivoPortada = null;
        portadaPreview.innerHTML = '';
        portadaInput.value = '';
      };

      container.appendChild(btnEliminar);
      portadaPreview.appendChild(container);
    };
    reader.readAsDataURL(archivo);
  }

  imagenesInput.addEventListener('change', (e) => {
    const nuevosArchivos = Array.from(e.target.files);
    if (archivosImagenes.length + nuevosArchivos.length > 5) {
      alert('Solo puedes subir hasta 5 imágenes.');
      return;
    }

    archivosImagenes = archivosImagenes.concat(nuevosArchivos);
    actualizarPreview();
    imagenesInput.value = '';
  });

  function actualizarPreview() {
    imagenesPreview.innerHTML = '';

    archivosImagenes.forEach((archivo, index) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        const container = document.createElement('div');
        container.style.position = 'relative';
        container.style.width = '100px';
        container.style.height = '100px';
        container.style.border = '1px solid #ccc';
        container.style.borderRadius = '4px';
        container.style.overflow = 'hidden';

        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        container.appendChild(img);

        const btnEliminar = document.createElement('button');
        btnEliminar.innerHTML = '&times;';
        btnEliminar.type = 'button';
        btnEliminar.title = 'Eliminar imagen';
        Object.assign(btnEliminar.style, {
          position: 'absolute', top: '2px', right: '2px', background: 'rgba(255, 0, 0, 0.8)', color: 'white',
          border: 'none', borderRadius: '50%', width: '20px', height: '20px', cursor: 'pointer',
          fontSize: '16px', lineHeight: '18px', padding: '0'
        });

        btnEliminar.onclick = () => {
          archivosImagenes.splice(index, 1);
          actualizarPreview();
        };

        container.appendChild(btnEliminar);
        imagenesPreview.appendChild(container);
      };
      reader.readAsDataURL(archivo);
    });
  }

  function validarFormulario() {
  let valido = true;

  // Validar nombre
  const inputNombre = document.getElementById("idNombre");
  const nombre = inputNombre.value.trim();
  const nombreExp = /^[a-zA-ZáéíóúüÁÉÍÓÚÜñÑçÇ0-9 .,'\-]{3,}$/;
  let errorNombre = document.getElementById("error-nombre");
  if (!errorNombre) {
    errorNombre = document.createElement("small");
    errorNombre.id = "error-nombre";
    errorNombre.style.color = "red";
    inputNombre.parentNode.appendChild(errorNombre);
  }
  if (!nombreExp.test(nombre)) {
    inputNombre.style.border = "2px solid red";
    errorNombre.textContent = "El nombre debe tener al menos 3 caracteres válidos.";
    errorNombre.style.display = "inline";
    valido = false;
  } else {
    inputNombre.style.border = "";
    errorNombre.style.display = "none";
  }

  // Validar precio
  const inputPrecio = document.getElementById("precio");
  const precio = parseFloat(inputPrecio.value);
  let errorPrecio = document.getElementById("error-precio");
  if (!errorPrecio) {
    errorPrecio = document.createElement("small");
    errorPrecio.id = "error-precio";
    errorPrecio.style.color = "red";
    inputPrecio.parentNode.appendChild(errorPrecio);
  }
  if (isNaN(precio) || precio < 0) {
    inputPrecio.style.border = "2px solid red";
    errorPrecio.textContent = "Introduce un precio válido mayor o igual a 0.";
    errorPrecio.style.display = "inline";
    valido = false;
  } else {
    inputPrecio.style.border = "";
    errorPrecio.style.display = "none";
  }

  // Validar descripción
  const inputDesc = document.getElementById("idDesc");
  const desc = inputDesc.value.trim();
  let errorDesc = document.getElementById("error-desc");
  if (!errorDesc) {
    errorDesc = document.createElement("small");
    errorDesc.id = "error-desc";
    errorDesc.style.color = "red";
    inputDesc.parentNode.appendChild(errorDesc);
  }
  if (desc.length < 10) {
    inputDesc.style.border = "2px solid red";
    errorDesc.textContent = "La descripción debe tener al menos 10 caracteres.";
    errorDesc.style.display = "inline";
    valido = false;
  } else {
    inputDesc.style.border = "";
    errorDesc.style.display = "none";
  }

  // Validar géneros
  const checkboxes = document.querySelectorAll('input[name="generosIds"]:checked');
  const errorGeneros = document.getElementById('error-generos');
  if (checkboxes.length === 0) {
    errorGeneros.style.display = "block";
    valido = false;
  } else {
    errorGeneros.style.display = "none";
  }

  // Validar portada
  const portadaInput = document.getElementById('portada');
  let errorPortada = document.getElementById("error-portada");
  if (!errorPortada) {
    errorPortada = document.createElement("small");
    errorPortada.id = "error-portada";
    errorPortada.style.color = "red";
    portadaInput.parentNode.appendChild(errorPortada);
  }
  if (!archivoPortada) {
    errorPortada.textContent = "Debes seleccionar una imagen de portada.";
    errorPortada.style.display = "inline";
    portadaInput.style.border = "2px solid red";
    valido = false;
  } else {
    errorPortada.style.display = "none";
    portadaInput.style.border = "";
  }

  // Validar archivo descargable
  const descargableInput = document.getElementById("descargable");
  const archivoDescargable = descargableInput.files[0];
  let errorDescargable = document.getElementById("error-descargable");
  if (!errorDescargable) {
    errorDescargable = document.createElement("small");
    errorDescargable.id = "error-descargable";
    errorDescargable.style.color = "red";
    descargableInput.parentNode.appendChild(errorDescargable);
  }
  if (!archivoDescargable) {
    descargableInput.style.border = "2px solid red";
    errorDescargable.textContent = "Selecciona un archivo descargable válido.";
    errorDescargable.style.display = "inline";
    valido = false;
  } else {
    descargableInput.style.border = "";
    errorDescargable.style.display = "none";
  }

  // Rellenar campos de imágenes seleccionadas
  const portadaDataTransfer = new DataTransfer();
  if (archivoPortada) {
    portadaDataTransfer.items.add(archivoPortada);
    portadaInput.files = portadaDataTransfer.files;
  }

  const imagenesDataTransfer = new DataTransfer();
  archivosImagenes.forEach(file => imagenesDataTransfer.items.add(file));
  document.getElementById("imagenes").files = imagenesDataTransfer.files;

  return valido;
}
</script>
